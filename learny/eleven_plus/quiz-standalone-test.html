<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>11+ Vocabulary Quiz - Test</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
  <script type="text/babel">
    // Default remote JSON (shortens code) with fallback to embedded data below
    const DEFAULT_DATA_URL = 'https://raw.githubusercontent.com/thorwhalen/learny/refs/heads/main/learny/eleven_plus/11plus_82_claude_words_game_params.json';
    // No embedded fallback; we will fetch from DEFAULT_DATA_URL on load.

    const ElevenPlusQuizApp = () => {
      // Game configuration will be loaded from the remote JSON
      const [gameParams, setGameParams] = React.useState({});
      const [words, setWords] = React.useState([]);

      // Data loading state
  const [dataSource, setDataSource] = React.useState({ type: 'url', label: 'Default URL (loading...)' });
      const [loading, setLoading] = React.useState(false);
      const [loadError, setLoadError] = React.useState(null);
      const [urlInput, setUrlInput] = React.useState(DEFAULT_DATA_URL);

      // App state
      const [gameMode, setGameMode] = React.useState('menu');
      const [currentQuestion, setCurrentQuestion] = React.useState(null);
      const [score, setScore] = React.useState({ correct: 0, total: 0 });
      const [feedback, setFeedback] = React.useState(null);
      const [usedWords, setUsedWords] = React.useState(new Set());

      const validateGameParams = (obj) => {
        // Minimal validation: non-null object with at least one key
        if (!obj || typeof obj !== 'object') return false;
        const keys = Object.keys(obj);
        if (keys.length === 0) return false;
        // Optionally ensure each entry is an object
        return true;
      };

      const applyDataset = (data, source) => {
        setGameParams(data);
        setWords(Object.keys(data));
        setDataSource(source);
        // Reset session state
        setUsedWords(new Set());
        setScore({ correct: 0, total: 0 });
        setFeedback(null);
        setCurrentQuestion(null);
        setGameMode('menu');
      };

      const loadFromUrl = async (url, { setAsSourceLabel } = {}) => {
        try {
          setLoading(true);
          setLoadError(null);
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const json = await res.json();
          if (!validateGameParams(json)) throw new Error('Invalid JSON structure');
          applyDataset(json, { type: 'url', label: setAsSourceLabel || url });
        } catch (err) {
          setLoadError(`Failed to load JSON from URL. ${err?.message || err}`);
        } finally {
          setLoading(false);
        }
      };

      const handleFileUpload = (file) => {
        if (!file) return;
        setLoading(true);
        setLoadError(null);
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const json = JSON.parse(reader.result);
            if (!validateGameParams(json)) throw new Error('Invalid JSON structure');
            applyDataset(json, { type: 'file', label: file.name });
          } catch (err) {
            setLoadError(`Failed to parse JSON file. ${err?.message || err}`);
          } finally {
            setLoading(false);
          }
        };
        reader.onerror = () => {
          setLoading(false);
          setLoadError('Failed to read file.');
        };
        reader.readAsText(file);
      };

      // Attempt to load default remote JSON once on mount
      React.useEffect(() => {
        loadFromUrl(DEFAULT_DATA_URL, { setAsSourceLabel: 'Default URL' });
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, []);

            const shuffleArray = (array) => {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            };

            const generateSynonymQuestion = () => {
                const availableWords = words.filter(word => !usedWords.has(word));
                if (availableWords.length === 0) {
                    setUsedWords(new Set());
                    return generateSynonymQuestion();
                }

                const word = availableWords[Math.floor(Math.random() * availableWords.length)];
                const wordConfig = gameParams[word];
                
                if (!wordConfig) {
                    return generateSynonymQuestion();
                }
                
                const isAntonym = Math.random() < 0.5;
                const questionType = isAntonym ? 'antonyms' : 'synonyms';
                const questionConfig = wordConfig[questionType];
                
                if (!questionConfig) {
                    return generateSynonymQuestion();
                }

                const options = [...questionConfig.choices];
                const correctAnswer = questionConfig.correct;

                return {
                    type: 'synonym',
                    word,
                    question: `What is a ${isAntonym ? 'antonym' : 'synonym'} for "${word}"?`,
                    options: shuffleArray(options),
                    correctAnswer,
                    explanation: `"${correctAnswer}" is a ${isAntonym ? 'antonym' : 'synonym'} of "${word}".`
                };
            };

      // Generate an Odd One Out question using the precomputed choices/correct
      const generateOddOneOutQuestion = () => {
        const availableWords = words.filter(word => !usedWords.has(word));
        if (availableWords.length === 0) {
          setUsedWords(new Set());
          return generateOddOneOutQuestion();
        }

        const word = availableWords[Math.floor(Math.random() * availableWords.length)];
        const wordConfig = gameParams[word];
        if (!wordConfig || !wordConfig.odd_one_out) {
          return generateOddOneOutQuestion();
        }

        const { choices, correct } = wordConfig.odd_one_out;
        if (!choices || !correct) {
          return generateOddOneOutQuestion();
        }

        return {
          type: 'odd_one_out',
          word,
          question: `Select the odd one out`,
          options: shuffleArray([...choices]),
          correctAnswer: correct,
          explanation: `"${correct}" is the odd one out among the choices for "${word}".`
        };
      };

      // Generate an Analogies question using the provided analogy template
      const generateAnalogyQuestion = () => {
        const availableWords = words.filter(word => !usedWords.has(word));
        if (availableWords.length === 0) {
          setUsedWords(new Set());
          return generateAnalogyQuestion();
        }

        const word = availableWords[Math.floor(Math.random() * availableWords.length)];
        const wordConfig = gameParams[word];
        if (!wordConfig || !wordConfig.analogies) {
          return generateAnalogyQuestion();
        }

        const { first, second, relation, choices, correct } = wordConfig.analogies;
        if (!choices || !correct || !first || !second) {
          return generateAnalogyQuestion();
        }

        return {
          type: 'analogies',
          word,
          question: `Complete the analogy: ${first} is to ${second} as "${word}" is to ?`,
          options: shuffleArray([...choices]),
          correctAnswer: correct,
          explanation: `The pair ("${word}", "${correct}") matches the relation "${relation}" like (${first}, ${second}).`
        };
      };

      const generateQuestion = (mode) => {
        switch (mode) {
          case 'odd_one_out':
            return generateOddOneOutQuestion();
          case 'analogies':
            return generateAnalogyQuestion();
          case 'synonyms':
          default:
            return generateSynonymQuestion();
        }
      };

      const startGame = (mode) => {
        // Guard against starting before data is loaded
        if (!words || words.length === 0) {
          setLoadError('No words loaded yet. Please wait for the dataset to load or load a dataset.');
          return;
        }
        setGameMode(mode);
        setScore({ correct: 0, total: 0 });
        setUsedWords(new Set());
        setFeedback(null);

        const firstQuestion = generateQuestion(mode);
        setCurrentQuestion(firstQuestion);
      };

            const handleAnswer = (selectedAnswer) => {
                const isCorrect = selectedAnswer === currentQuestion.correctAnswer;
                const newScore = {
                    correct: score.correct + (isCorrect ? 1 : 0),
                    total: score.total + 1
                };
                
                setScore(newScore);
                setUsedWords(prev => new Set([...prev, currentQuestion.word]));
                
                setFeedback({
                    isCorrect,
                    explanation: currentQuestion.explanation,
                    selectedAnswer,
                    correctAnswer: currentQuestion.correctAnswer
                });
            };

      const nextQuestion = () => {
        setFeedback(null);
        const newQuestion = generateQuestion(gameMode);
        setCurrentQuestion(newQuestion);
      };

            const backToMenu = () => {
                setGameMode('menu');
                setCurrentQuestion(null);
                setFeedback(null);
                setScore({ correct: 0, total: 0 });
                setUsedWords(new Set());
            };

            if (gameMode === 'menu') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
                        <div className="max-w-4xl mx-auto">
                            <div className="text-center mb-12">
                                <h1 className="text-5xl font-bold text-indigo-900 mb-4">11+ Vocabulary Quiz</h1>
                                <p className="text-xl text-indigo-700">Words: {words.length} {loading ? '(Loading...)' : ''}</p>
                                <p className="text-sm text-indigo-600 mt-1">Source: {dataSource.label}</p>
                                {loadError && (
                                  <div className="mt-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded p-2">
                                    {loadError}
                                  </div>
                                )}
                            </div>
                            {/* Dataset loader */}
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-8 border border-indigo-100">
                              <h2 className="text-xl font-semibold text-indigo-900 mb-4">Load custom dataset (optional)</h2>
                              <div className="grid md:grid-cols-2 gap-6">
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Upload JSON file</label>
                                  <input
                                    type="file"
                                    accept="application/json,.json"
                                    className="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"
                                    onChange={(e) => handleFileUpload(e.target.files?.[0])}
                                    disabled={loading}
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Load from URL</label>
                                  <div className="flex gap-2">
                                    <input
                                      type="url"
                                      className="flex-1 rounded-lg border border-gray-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                      placeholder="https://.../words.json"
                                      value={urlInput}
                                      onChange={(e) => setUrlInput(e.target.value)}
                                      disabled={loading}
                                    />
                                    <button
                                      onClick={() => loadFromUrl(urlInput)}
                                      disabled={loading || !urlInput}
                                      className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg disabled:opacity-50"
                                    >Load</button>
                                  </div>
                                  <div className="flex gap-2 mt-2">
                                    <button
                                      onClick={() => loadFromUrl(DEFAULT_DATA_URL, { setAsSourceLabel: 'Default URL' })}
                                      disabled={loading}
                                      className="text-indigo-700 bg-indigo-50 hover:bg-indigo-100 px-3 py-1.5 rounded-lg text-sm"
                                    >Use default URL</button>
                                  </div>
                                </div>
                              </div>
                              <p className="text-xs text-gray-500 mt-3">Note: The JSON should be a mapping from word to its game parameters (synonyms/antonyms/odd_one_out/analogies).</p>
                            </div>

              {(() => { const canPlay = words.length > 0 && !loading; return (
              <div className="grid md:grid-cols-3 gap-8">
                <div
                  onClick={canPlay ? () => startGame('synonyms') : undefined}
                  className={`bg-white rounded-xl shadow-lg p-8 transform transition-all duration-200 border-2 ${canPlay ? 'cursor-pointer hover:scale-105 hover:shadow-xl hover:border-indigo-300' : 'opacity-50 cursor-not-allowed'}`}
                  aria-disabled={!canPlay}
                >
                  <div className="text-center">
                    <div className="text-4xl mb-4">📚</div>
                    <h3 className="text-2xl font-bold text-indigo-900 mb-3">Synonyms & Antonyms</h3>
                    <p className="text-indigo-600 mb-4">Find words with similar or opposite meanings</p>
                  </div>
                </div>
                <div
                  onClick={canPlay ? () => startGame('odd_one_out') : undefined}
                  className={`bg-white rounded-xl shadow-lg p-8 transform transition-all duration-200 border-2 ${canPlay ? 'cursor-pointer hover:scale-105 hover:shadow-xl hover:border-indigo-300' : 'opacity-50 cursor-not-allowed'}`}
                  aria-disabled={!canPlay}
                >
                  <div className="text-center">
                    <div className="text-4xl mb-4">🧩</div>
                    <h3 className="text-2xl font-bold text-indigo-900 mb-3">Odd One Out</h3>
                    <p className="text-indigo-600 mb-4">Pick the option that does not belong</p>
                  </div>
                </div>
                <div
                  onClick={canPlay ? () => startGame('analogies') : undefined}
                  className={`bg-white rounded-xl shadow-lg p-8 transform transition-all duration-200 border-2 ${canPlay ? 'cursor-pointer hover:scale-105 hover:shadow-xl hover:border-indigo-300' : 'opacity-50 cursor-not-allowed'}`}
                  aria-disabled={!canPlay}
                >
                  <div className="text-center">
                    <div className="text-4xl mb-4">🔗</div>
                    <h3 className="text-2xl font-bold text-indigo-900 mb-3">Analogies</h3>
                    <p className="text-indigo-600 mb-4">Complete the analogy with the best match</p>
                  </div>
                </div>
              </div>
              ); })()}
                        </div>
                    </div>
                );
            }

            if (!currentQuestion) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-4xl mb-4">🔄</div>
                            <p className="text-xl text-indigo-700">Loading question...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                            <div className="flex justify-between items-center">
                                <h1 className="text-2xl font-bold text-gray-900">{gameMode === 'synonyms' ? 'Synonyms & Antonyms' : gameMode === 'odd_one_out' ? 'Odd One Out' : 'Analogies'}</h1>
                                <button
                                    onClick={backToMenu}
                                    className="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"
                                >
                                    Back to Menu
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
                            <div className="flex justify-between items-center">
                                <div className="flex space-x-8">
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-green-600">{score.correct}</div>
                                        <div className="text-sm text-gray-600">Correct</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-blue-600">{score.total}</div>
                                        <div className="text-sm text-gray-600">Total</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg p-8 mb-8">
                            <div className="text-center mb-8">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                    {currentQuestion.question}
                                </h2>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                                {currentQuestion.options.map((option, index) => (
                                    <button
                                        key={index}
                                        onClick={() => handleAnswer(option)}
                                        disabled={feedback !== null}
                                        className={`p-4 rounded-lg border-2 transition-all duration-200 text-left ${
                                            feedback === null
                                                ? 'border-gray-300 hover:border-blue-400 hover:bg-blue-50'
                                                : feedback.selectedAnswer === option
                                                ? feedback.isCorrect
                                                    ? 'border-green-500 bg-green-50'
                                                    : 'border-red-500 bg-red-50'
                                                : option === currentQuestion.correctAnswer
                                                ? 'border-green-500 bg-green-50'
                                                : 'border-gray-300 bg-gray-50'
                                        }`}
                                    >
                                        <span className="text-lg">{option}</span>
                                    </button>
                                ))}
                            </div>

                            {feedback && (
                                <div className={`rounded-lg p-6 mb-6 ${
                                    feedback.isCorrect ? 'bg-green-50 border-l-4 border-green-400' : 'bg-red-50 border-l-4 border-red-400'
                                }`}>
                                    <h3 className={`text-xl font-bold mb-3 ${
                                        feedback.isCorrect ? 'text-green-800' : 'text-red-800'
                                    }`}>
                                        {feedback.isCorrect ? 'Correct!' : 'Not quite right'}
                                    </h3>
                                    <p className={`text-lg ${
                                        feedback.isCorrect ? 'text-green-700' : 'text-red-700'
                                    }`}>
                                        {feedback.explanation}
                                    </p>
                                </div>
                            )}

                            {feedback && (
                                <div className="text-center">
                                    <button
                                        onClick={nextQuestion}
                                        className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg text-lg font-semibold transition-colors"
                                    >
                                        Next Question →
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ElevenPlusQuizApp />);
    </script>
</body>
</html>